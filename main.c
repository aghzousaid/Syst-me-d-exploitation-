#include <stdio.h>
#include <string.h>
//the maximal number of process
#define NBPROCESSMAX 1000

 //function FIFO
 int fifo (int n, int bt[]) {
	 //array of waiting time
	  int wt[n],
	 //array of turnaround time 
	  tat[n],
	  i,j;
	 //waiting time for first process is 0
	  wt[0] = 0;   
	 //average waiting time initialised with 0 at the first time
	  double  avwt=0,
	 //average turnaround time 
	  avtat=0;
        //to calculate waiting time
        for(i=1;i<n;i++)
        {
            wt[i]=0;
            for(j=0;j<i;j++)
                wt[i]+=bt[j];
        }

   	 printf("\nProcess\t\tBurst Time\tWaiting Time\tTurnaround Time");

       // to calculate turnaround time/av
        for(i=0;i<n;i++)
        {
            tat[i]=bt[i]+wt[i];
            avwt+=wt[i];
            avtat+=tat[i];
        //display the result
            printf("\nP[%d]\t\t%d\t\t%d\t\t%d",i+1,bt[i],wt[i],tat[i]); 
        }
    
        avwt/=i;
        avtat/=i;
        //display Average Waiting Time
        printf("\n\nAverage Waiting Time:%lf seconds",avwt);
        //display Average Turnaround Time
        printf("\nAverage Turnaround Time:%lf seconds \n",avtat);
    
        return 0;
}
    
//Function SJF
int sjf (int n, int bt[]) {
     int p[n],
     wt[n], tat[n],
     i, j, total=0, pos, temp;
     float avg_wt,avg_tat;
    
        for(i=0;i<n;i++) {
        //array contains number of process
            p[i]=i+1;           
        }
        //sorting burst time in ascending order using selection sort
        for(i=0;i<n;i++) {
            pos=i;
            for(j=i+1;j<n;j++) {
                if(bt[j]<bt[pos])
                    pos=j;
            }
    
            temp=bt[i];
            bt[i]=bt[pos];
            bt[pos]=temp;
    
            temp=p[i];
            p[i]=p[pos];
            p[pos]=temp;
        }
        
        //waiting time for first process will be zero
        wt[0]=0;           
    
        //to calculate waiting time
        for(i=1;i<n;i++)
        {
            wt[i]=0;
            for(j=0;j<i;j++)
                wt[i]+=bt[j];
    
            total+=wt[i];
        }
        
        //to calculate average waiting time
        avg_wt=(float)total/n;      
        total=0;
    
        printf("\nProcess\t    Burst Time    \tWaiting Time\tTurnaround Time");
        for(i=0;i<n;i++)
        {   
        //to calculate turnaround time
           tat[i]=bt[i]+wt[i];     
           total+=tat[i];
           printf("\nP[%d]\t\t  %d\t\t    %d\t\t\t%d",p[i],bt[i],wt[i],tat[i]);
       }
       
       //to calculate average Turnaround Time
       avg_tat=(float)total/n;    
       printf("\n\nAverage Waiting Time=%.2f seconds", avg_wt);
       printf("\nAverage Turnaround Time=%.2f seconds \n", avg_tat);
   
}
 

//function SJRF
int sjrf (int n, int bt[n], int pr[n]) {
     int wt[n],tat[n],p[n], i,j,total=0,pos,temp;
     float avg_wt = 0, avg_tat = 0;

     for(i=0;i<n;i++) {
	 //contains process number
         p[i]=i+1;           
     }

     //sorting burst time, priority and process number in ascending order using selection sort
     for(i=0;i<n;i++)
     {
         pos=i;
         for(j=i+1;j<n;j++)
         {
            if(pr[j]<pr[pos])
                 pos=j;
         }

         temp=pr[i];
         pr[i]=pr[pos];
         pr[pos]=temp;

         temp=bt[i];
         bt[i]=bt[pos];
         bt[pos]=temp;

         temp=p[i];
         p[i]=p[pos];
         p[pos]=temp;
     }
     //waiting time for first process is zero
     wt[0]=0;    

     //calculate waiting time
     for(i=1;i<n;i++)
     {
         wt[i]=0;
         for(j=0;j<i;j++)
            wt[i]+=bt[j];

         total+=wt[i];
     }
     
     //to calculate average waiting time
     avg_wt=(float)total/n;      
     total=0;

     printf("\nProcess\t\tBurst Time\tPriority Time\tWaiting Time\tTurnaround Time");
     for(i=0;i<n;i++)
     {
	 //calculate turnaround time
         tat[i]=bt[i]+wt[i];     
         total+=tat[i];
         printf("\nP[%d]\t\t%d\t\t%d\t\t%d\t\t%d",p[i],bt[i],pr[i],wt[i],tat[i]);
     }

     //average turnaround time
     avg_tat=(float)total/n;    
     printf("\n\nAverage Waiting Time=%.2f seconds",avg_wt);
     printf("\nAverage Turnaround Time=%.2f seconds\n",avg_tat);

     return 0;

}

//function RR
int rr (int n, int bt[n], int at[n], int time_quantum) {
     int queue[1000];
     int i,j,k,y,total = 0, x, finish_flag = 0, current_process, flag_inQueue;
       	int wait_time, turnaround_time = 0, 
	//temp is the remaining time for each process
	temp[n]; 
     	float total_wait_time = 0, total_turnaround_time = 0;
	//countdown to be sure all process are finished
       	x = n; 
          for(j = 0; j < n; j++) {
			 //initial remaining time is the burst time
    		         temp[j] = bt[j]; 
  	     }

          printf("\nProcess\t\tBurst Time\tArrival Time\tWaiting Time\tTurnaround Time");
	  //total time
          total = 0; 
          /* the first process to enter in the queue is the first process, i keeps track of the actual position of the queue*/
          i = 0;
	  /* k keeps track of the last position */
          k = 0; 
          queue[i] = 1;

          while(x != 0)
       	{
               current_process = queue[i];

               /* if the remaining time is exactly the quantum time */
         		if(temp[current_process-1] <= time_quantum && temp[current_process-1] > 0)
         		{
           			total = total + temp[current_process-1];
				//then the remaining time go to 0
           			temp[current_process-1] = 0; 
         		}
         		else if(temp[current_process-1] > 0)
         		{
           			temp[current_process-1] = temp[current_process-1] - time_quantum;
           			total = total + time_quantum;
         		}
               /*If the process has ended */
         		if(temp[current_process-1] == 0)
         		{
           		x--;
                    turnaround_time = total - at[current_process-1];
                    wait_time = turnaround_time - bt[current_process-1];
      			printf("\nP[%d]\t\t%d\t\t%d\t\t%d\t\t%d", current_process, bt[current_process-1], at[current_process-1], wait_time, turnaround_time);

           			total_wait_time = total_wait_time + wait_time;
                         total_turnaround_time = total_turnaround_time + turnaround_time;

         		}

               /* For every other process, sees if they reached their arrival time */
               for(j = 0; j < n; j++) {
                    /* Insert the process in the queue if needed*/
                    if (at[j] <= total && temp[j] != 0 && j != current_process-1) {
                         flag_inQueue = 0;
                         /* Verifies first if the process is already in the queue  */
                         for (y=i; y <= k; y++) {
                              if (queue[y] == j+1) {
                                   flag_inQueue = 1;
                                   break;
                              }
                         }
                         /* if its not, insert in the queue */
                         if (flag_inQueue == 0) {
                              queue[k+1] = j+1;
                              k++;
                         }

                    }
               }

               /*If the current process is not finished yet, put it in the queue*/
               if (temp[current_process-1] != 0) {
                    queue[k+1] = current_process;
                    k++;
               }

               i++;
     	}

     	float average_wait_time = total_wait_time * 1.0 / n;
     	float average_turnaround_time = total_turnaround_time * 1.0 / n;
       	printf("\n\nAverage Waiting Time:\t%f seconds", average_wait_time);
       	printf("\nAvg Turnaround Time:\t%f seconds\n", average_turnaround_time);
       	return 0;

}
////function to read data from  a file
int reading_from_file (int* n, int bt[], int priorities[], int arrival_time[], int* quantum_time, int* chosen_algo) {
     int line_counter = 1;
     FILE* fichier = NULL;
    char c;
    fichier = fopen("input_file.txt", "r");
    char line_string[1000];
    char number_string[5];
    int i, j, k, n_aux, nb_proc;

    if(fichier != NULL){
         if (line_counter == 1) {
              fgets(number_string, 1000, fichier);
              nb_proc = atoi(number_string);
              *n = nb_proc;
              line_counter++;
              strcpy(number_string, "");
         }

         if (line_counter == 2) {
              fgets(line_string, 1000, fichier);
              i = 0;
              j = 0;
              k = 0;
              c = line_string[0];
              while (c != '\n') {
                   c = line_string[i];
                   if (c != ' ' && c != '\n') {
                        number_string[j] = c;
                        j++;
                   }
                   else {
                        j = 0;
                        n_aux = atoi(number_string);
                        bt[k] = n_aux;
                        k++;
                        strcpy(number_string, "");
                        //printf("%d ", n_aux);
                   }
                   i++;
              }
              line_counter++;

         }

         if (line_counter == 3) {
              fgets(number_string, 5, fichier);
              *chosen_algo = atoi(number_string);
              /* FIFO */
              if (n_aux == 1) {
                   fclose(fichier);
                   return 0;
              }

              /* SFJ */
              if (n_aux == 2) {
                   fclose(fichier);
                   return 0;
              }

              line_counter++;
              strcpy(number_string, "");
         }

         if (line_counter == 4) {
              if (*chosen_algo == 3) {
                   strcpy(line_string, "");
                   fgets(line_string, 1000, fichier);
                   i = 0;
                   j = 0;
                   k = 0;
                   c = line_string[0];
                   while (c != '\n') {
                        c = line_string[i];
                        if (c != ' ' && c != '\n') {
                             number_string[j] = c;
                             j++;
                        }
                        else {
                             j = 0;
                             n_aux = atoi(number_string);
                             priorities[k] = n_aux;
                             k++;
                             strcpy(number_string, "");
                             //printf("%d ", n_aux);
                        }
                        i++;
                   }

                   fclose(fichier);
                   return 0;
              }

              else if (*chosen_algo == 4) {
                   strcpy(line_string, "");
                   fgets(line_string, 1000, fichier);
                   i = 0;
                   j = 0;
                   k = 0;
                   c = line_string[0];
                   while (c != '\n') {
                        c = line_string[i];
                        if (c != ' ' && c != '\n') {
                             number_string[j] = c;
                             j++;
                        }
                        else {
                             j = 0;
                             n_aux = atoi(number_string);
                             arrival_time[k] = n_aux;
                             k++;
                             strcpy(number_string, "");
                             //printf("%d ", n_aux);
                        }
                        i++;
                   }
              }
             line_counter++;
         }

         if (line_counter == 5) {
              strcpy(number_string, "");
              fgets(number_string, 5, fichier);
              *quantum_time = atoi(number_string);
              fclose(fichier);
              line_counter = 0;
              strcpy(number_string, "");
              return 0;
         }
    }
}


int main () {
     int n,i,j,f;
     int bt[NBPROCESSMAX];
     int priorities[NBPROCESSMAX];
     int arrival_time[NBPROCESSMAX];
     int quantum_time;
     int chosen_algo;

do{
     printf("\nEnter 1 to read input from the file 'input_file.txt'. \nEnter 2 for manual input. \nEnter 3 to exit\n");
     scanf("%d",&f);
        if (f == 1) {
             reading_from_file(&n, bt, priorities, arrival_time, &quantum_time, &chosen_algo);
        }

        else if (f == 2) {
             printf("Enter Total Number of Process:");
             scanf("%d",&n);

             printf("\nEnter Process Burst Time\n");
             for(i=0;i<n;i++)
             {
                 printf("P[%d]:",i+1);
                 scanf("%d",&bt[i]);
             }

             printf("Chose your algorithm...Enter:\n1 for FIFO.\n2 for SJF.\n3 for SJRF.\n4 for RR\n");
             scanf("%d", &chosen_algo);


             if (chosen_algo == 3) {
                  printf("\nEnter Priorities times\n");
                  for(i=0;i<n;i++)
                  {
                      printf("P[%d]:",i+1);
                      scanf("%d",&priorities[i]);
                  }
             }

             if (chosen_algo == 4) {
                  printf("\nEnter Arrivals Times\n");
                  for(i=0;i<n;i++)
                  {
                      printf("P[%d]:",i+1);
                      scanf("%d",&arrival_time[i]);
                  }
                  printf("\nEnter Quantum Time\n");
                  scanf("%d",&quantum_time);
             }
        }
	else {
		if(f == 3) {
      		break;
		}
	}


        /* Menu displaying all the chosen configurations */

        printf(".....................................................\n");
        printf("...............Choosed configurations................\n");
        printf(".....................................................\n \n");

        if (chosen_algo == 1) {
             printf("Chosen Algorithm.................. FIFO. \n", n);
             printf("Number of processes.................. %d \n", n);

        }

        if (chosen_algo == 2) {
            printf("Chosen Algorithm.................. SFJ. \n", n);
            printf("Number of processes.................. %d \n", n);
        }

        if (chosen_algo == 3) {
             printf("Chosen Algorithm.................. SJRF. \n", n);
             printf("Number of processes.................. %d \n", n);

        }

        if (chosen_algo == 4) {
            printf("Chosen Algorithm.................. RR \n", n);
            printf("Quantum Time.................. %d \n", quantum_time);
        }




        /* Running the algo */

        if (chosen_algo == 1) {
             fifo(n, bt);
        }

        if (chosen_algo == 2) {
             sjf(n, bt);
        }

        if (chosen_algo == 3 ) {
             sjrf(n, bt, priorities);
        }

        if (chosen_algo == 4) {
             rr(n, bt, arrival_time, quantum_time);
        }
}while(f!=3);

}
